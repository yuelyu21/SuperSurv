<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>5. Machine Learning with Random Survival Forests • SuperSurv</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="5. Machine Learning with Random Survival Forests">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">SuperSurv</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/supersurv-ensemble.html">Get Started</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-tutorials" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Tutorials</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-tutorials">
<li><a class="dropdown-item" href="../articles/supersurv-ensemble.html">1. The SuperSurv Ensemble</a></li>
    <li><a class="dropdown-item" href="../articles/supersurv-best.html">2. Selection vs. Ensemble</a></li>
    <li><a class="dropdown-item" href="../articles/model-performance.html">3. Model Performance</a></li>
    <li><a class="dropdown-item" href="../articles/screening-methods.html">4. Screening Methods</a></li>
    <li><a class="dropdown-item" href="../articles/base-learner-rfsrc.html">5. Random Forests (rfsrc)</a></li>
    <li><a class="dropdown-item" href="../articles/parametric-models.html">6. Parametric Models</a></li>
    <li><a class="dropdown-item" href="../articles/shap-explanations.html">7. SHAP Interpretability</a></li>
    <li><a class="dropdown-item" href="../articles/scaleup-parallel.html">8. Parallel Processing</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/yuelyu21/SuperSurv" aria-label="GitHub"><span class="fa fa-github"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>5. Machine Learning with Random Survival Forests</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/yuelyu21/SuperSurv/blob/master/vignettes/base-learner-rfsrc.Rmd" class="external-link"><code>vignettes/base-learner-rfsrc.Rmd</code></a></small>
      <div class="d-none name"><code>base-learner-rfsrc.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>While classical models like the Cox Proportional Hazards model are
highly interpretable, they rely on strict assumptions of linear,
additive effects. In complex biological systems, predictors often
interact in highly non-linear ways.</p>
<p>Random Survival Forests (RSF), implemented via the
<code>randomForestSRC</code> package, overcome this by building an
ensemble of decision trees. <code>SuperSurv</code> natively supports
RSF. This tutorial demonstrates how to include RSF in your ensemble and
how to perform automated hyperparameter tuning using
<code>SuperSurv</code>’s <code>create_surv_grid</code> function.</p>
</div>
<div class="section level2">
<h2 id="prepare-the-data">1. Prepare the Data<a class="anchor" aria-label="anchor" href="#prepare-the-data"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/yuelyu21/SuperSurv" class="external-link">SuperSurv</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/therneau/survival" class="external-link">survival</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"metabric"</span>, package <span class="op">=</span> <span class="st">"SuperSurv"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="va">train_idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">metabric</span><span class="op">)</span>, <span class="fl">0.7</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">metabric</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">train</span> <span class="op">&lt;-</span> <span class="va">metabric</span><span class="op">[</span><span class="va">train_idx</span>, <span class="op">]</span></span>
<span><span class="va">test</span>  <span class="op">&lt;-</span> <span class="va">metabric</span><span class="op">[</span><span class="op">-</span><span class="va">train_idx</span>, <span class="op">]</span></span>
<span></span>
<span><span class="va">X_tr</span> <span class="op">&lt;-</span> <span class="va">train</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"^x"</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">metabric</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">X_te</span> <span class="op">&lt;-</span> <span class="va">test</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"^x"</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">metabric</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">new.times</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">50</span>, <span class="fl">200</span>, by <span class="op">=</span> <span class="fl">25</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="the-power-of-hyperparameter-tuning">2. The Power of Hyperparameter Tuning<a class="anchor" aria-label="anchor" href="#the-power-of-hyperparameter-tuning"></a>
</h2>
<p>A single Random Forest configuration is rarely optimal for every
dataset. In the Super Learner framework, we handle “tuning” by adding
multiple versions of the same algorithm to our library, each with
different hyperparameters (like tree depth or node size). The
meta-learner automatically evaluates them via cross-validation and
assigns the highest weight to the best configuration.</p>
<div class="section level3">
<h3 id="approach-a-manual-wrappers-the-hard-way">Approach A: Manual Wrappers (The Hard Way)<a class="anchor" aria-label="anchor" href="#approach-a-manual-wrappers-the-hard-way"></a>
</h3>
<p>You could manually define individual R functions for every parameter
combination:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># A "Fast/Shallow" Forest</span></span>
<span><span class="va">surv.rfsrc.shallow</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span>, <span class="va">nodesize</span> <span class="op">=</span> <span class="fl">15</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/surv.rfsrc.html">surv.rfsrc</a></span><span class="op">(</span><span class="va">...</span>, nodesize <span class="op">=</span> <span class="va">nodesize</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># A "Deep/Complex" Forest</span></span>
<span><span class="va">surv.rfsrc.deep</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span>, <span class="va">nodesize</span> <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/surv.rfsrc.html">surv.rfsrc</a></span><span class="op">(</span><span class="va">...</span>, nodesize <span class="op">=</span> <span class="va">nodesize</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="approach-b-automated-tuning-with-create_grid-the-supersurv-way">Approach B: Automated Tuning with <code>create_grid</code> (The
SuperSurv Way)<a class="anchor" aria-label="anchor" href="#approach-b-automated-tuning-with-create_grid-the-supersurv-way"></a>
</h3>
<p>Instead of writing manual wrapper functions for every combination,
<code>SuperSurv</code> provides the <code>create_grid</code> function.
You simply supply the base learner name and a list of hyperparameter
values. The function automatically generates the wrapper functions in
your environment and returns a character vector of their names, ready to
be passed into the Super Learner library!</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define our hyperparameter search space</span></span>
<span><span class="va">rf_tuning_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  nodesize <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">15</span>, <span class="fl">30</span><span class="op">)</span>, <span class="co"># Deep vs. Shallow trees</span></span>
<span>  ntree <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">500</span><span class="op">)</span>      <span class="co"># Number of trees in the forest</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Automatically generate 6 different Random Forest wrappers</span></span>
<span><span class="va">rf_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_grid.html">create_grid</a></span><span class="op">(</span>base_learner <span class="op">=</span> <span class="st">"surv.rfsrc"</span>, </span>
<span>                            grid_params <span class="op">=</span> <span class="va">rf_tuning_params</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># View the dynamically generated function names</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">rf_grid</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "surv.rfsrc_1" "surv.rfsrc_2" "surv.rfsrc_3" "surv.rfsrc_4" "surv.rfsrc_5"</span></span>
<span><span class="co">#&gt; [6] "surv.rfsrc_6"</span></span>
<span></span>
<span><span class="co"># Combine the tuned ML grid with our baseline Cox model</span></span>
<span><span class="va">my_ml_library</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"surv.coxph"</span>, <span class="va">rf_grid</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="fit-the-super-learner">3. Fit the Super Learner<a class="anchor" aria-label="anchor" href="#fit-the-super-learner"></a>
</h2>
<p>We pass our expanded, tuned library into <code>SuperSurv</code>. The
internal cross-validation will pit the linear Cox model against all 6
variations of the non-linear Random Forest.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_rf_ensemble</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SuperSurv.html">SuperSurv</a></span><span class="op">(</span></span>
<span>  time <span class="op">=</span> <span class="va">train</span><span class="op">$</span><span class="va">duration</span>,</span>
<span>  event <span class="op">=</span> <span class="va">train</span><span class="op">$</span><span class="va">event</span>,</span>
<span>  X <span class="op">=</span> <span class="va">X_tr</span>,</span>
<span>  newX <span class="op">=</span> <span class="va">X_te</span>,</span>
<span>  new.times <span class="op">=</span> <span class="va">new.times</span>,</span>
<span>  event.SL.library <span class="op">=</span> <span class="va">my_ml_library</span>,</span>
<span>  cens.SL.library <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"surv.coxph"</span><span class="op">)</span>, <span class="co"># Keep censoring simple to speed up computation</span></span>
<span>  control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>saveFitLibrary <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  selection <span class="op">=</span> <span class="st">"ensemble"</span>,</span>
<span>  nFolds <span class="op">=</span> <span class="fl">3</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="inspecting-the-learned-weights">4. Inspecting the Learned Weights<a class="anchor" aria-label="anchor" href="#inspecting-the-learned-weights"></a>
</h2>
<p>Let’s see how the meta-learner distributed the weights. This step
essentially tells us the “winning” hyperparameter combination for this
specific dataset.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Extract and round the meta-learner weights</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">fit_rf_ensemble</span><span class="op">$</span><span class="va">event.coef</span>, <span class="fl">4</span><span class="op">)</span></span>
<span><span class="co">#&gt;   surv.coxph_screen.all surv.rfsrc_1_screen.all surv.rfsrc_2_screen.all </span></span>
<span><span class="co">#&gt;                  0.3466                  0.1299                  0.3967 </span></span>
<span><span class="co">#&gt; surv.rfsrc_3_screen.all surv.rfsrc_4_screen.all surv.rfsrc_5_screen.all </span></span>
<span><span class="co">#&gt;                  0.0000                  0.1267                  0.0000 </span></span>
<span><span class="co">#&gt; surv.rfsrc_6_screen.all </span></span>
<span><span class="co">#&gt;                  0.0000</span></span></code></pre></div>
<p>By leveraging <code>create_surv_grid()</code>, you can easily execute
a massive hyperparameter search space, mathematically guaranteeing that
your final ensemble minimizes the cross-validated risk without any
manual trial-and-error!</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://scholar.google.com/citations?hl=en&amp;user=PFjMl6sAAAAJ" class="external-link">Yue Lyu</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
